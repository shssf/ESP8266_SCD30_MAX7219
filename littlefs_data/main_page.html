<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wemos Control</title>
    <link rel="stylesheet" href="/style.css" />
</head>

<body>
    <div class="container">
    <h1 id="title">Wemos D1 mini + SCD30</h1>

    <div class="card">
        <div class="section-title">Navigation</div>
        <div class="action-row">
            <button class="btn btn-primary" type="button" onclick="location.href='/scd30'">SCD30</button>
            <button class="btn btn-primary" type="button" onclick="location.href='/ota'">Web OTA</button>
        </div>
        <p class="hint">Links: <a class="mono" href="/api/main">/api/main</a></p>
    </div>

    <div class="card">
        <div class="section-title">Device actions</div>
        <div class="action-row">
            <button id="rebootBtn" class="btn btn-accent" type="button">Reboot Device</button>
            <form method="POST" action="/reset">
                <button class="btn btn-default" type="submit">Clear WiFi Pass</button>
            </form>
        </div>
        <p id="mainActionMsg" class="hint">Use reboot to apply firmware/filesystem updates.</p>
    </div>

    <div class="sep"></div>

    <div class="columns">
        <div class="card">
            <div class="section-title">Network / Addressing</div>
            <table>
                <tr><td>Hostname</td><td id="hostname" class="mono">--</td></tr>
                <tr><td>IP</td><td id="ip" class="mono">--</td></tr>
                <tr><td>MAC</td><td id="mac" class="mono">--</td></tr>
                <tr><td>WiFi</td><td id="wifi">--</td></tr>
            </table>
        </div>
        <div class="card">
            <div class="section-title">Hardware info</div>
            <table>
                <tr><td>Chip ID</td><td id="chipId" class="mono">--</td></tr>
                <tr><td>CPU freq</td><td id="cpu" class="mono">--</td></tr>
                <tr><td>Flash size</td><td id="flash" class="mono">--</td></tr>
                <tr><td>Uptime</td><td id="uptime" class="mono">--</td></tr>
            </table>
        </div>
        <div class="card">
            <div class="section-title">System health</div>
            <table>
                <tr><td>Free heap</td><td id="freeHeap" class="mono">--</td></tr>
                <tr><td>Heap fragmentation</td><td id="heapFrag" class="mono">--</td></tr>
                <tr><td>Max free block</td><td id="maxFreeBlock" class="mono">--</td></tr>
                <tr><td>LittleFS used / total</td><td id="fsUsage" class="mono">--</td></tr>
                <tr><td>Last reset reason</td><td id="resetReason">--</td></tr>
            </table>
        </div>
    </div>

    <script>
        (function () {
            var title = document.getElementById('title');
            var hostname = document.getElementById('hostname');
            var ip = document.getElementById('ip');
            var mac = document.getElementById('mac');
            var wifi = document.getElementById('wifi');
            var chipId = document.getElementById('chipId');
            var cpu = document.getElementById('cpu');
            var flash = document.getElementById('flash');
            var uptime = document.getElementById('uptime');
            var freeHeap = document.getElementById('freeHeap');
            var heapFrag = document.getElementById('heapFrag');
            var maxFreeBlock = document.getElementById('maxFreeBlock');
            var fsUsage = document.getElementById('fsUsage');
            var resetReason = document.getElementById('resetReason');
            var rebootBtn = document.getElementById('rebootBtn');
            var mainActionMsg = document.getElementById('mainActionMsg');

            function fill(data) {
                title.textContent = 'Wemos D1 mini + SCD30 (built ' + (data.build || '--') + ')';
                hostname.textContent = data.hostname || '--';
                ip.textContent = data.ip || '--';
                mac.textContent = data.mac || '--';
                wifi.textContent = 'SSID: ' + (data.ssid || '--') + ', RSSI: ' + (data.rssi_dbm ?? '--') + ' dBm, Channel: ' + (data.channel ?? '--');
                chipId.textContent = data.chip_id || '--';
                cpu.textContent = (data.cpu_mhz ?? '--') + ' MHz';
                flash.textContent = (data.flash_size_bytes ?? '--') + ' B';
                uptime.textContent = data.uptime || '--';
                freeHeap.textContent = (data.free_heap_bytes ?? '--') + ' B';
                heapFrag.textContent = (data.heap_fragmentation_pct ?? '--') + ' %';
                maxFreeBlock.textContent = (data.max_free_block_bytes ?? '--') + ' B';
                fsUsage.textContent = (data.fs_used_bytes ?? '--') + ' / ' + (data.fs_total_bytes ?? '--') + ' B';
                resetReason.textContent = data.reset_reason || '--';
            }

            async function refresh() {
                try {
                    var response = await fetch('/api/main', { cache: 'no-store' });
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    var data = await response.json();
                    fill(data);
                } catch (e) {
                    console.warn('Failed to load /api/main', e);
                }
            }

            rebootBtn.addEventListener('click', function () {
                rebootBtn.disabled = true;
                mainActionMsg.textContent = 'Sending reboot command ...';
                fetch('/reboot', { method: 'POST' })
                    .then(function (resp) {
                        return resp.text().then(function (txt) {
                            return { status: resp.status, text: txt };
                        });
                    })
                    .then(function (res) {
                        rebootBtn.disabled = false;
                        if (res.status === 200) {
                            mainActionMsg.textContent = res.text || 'Rebooting...';
                            return;
                        }
                        if (res.status === 401) {
                            mainActionMsg.textContent = 'Auth required for reboot. Open /ota and authenticate first.';
                            return;
                        }
                        mainActionMsg.textContent = 'Reboot failed: HTTP ' + res.status + ' ' + (res.text || '');
                    })
                    .catch(function () {
                        rebootBtn.disabled = false;
                        mainActionMsg.textContent = 'Network error during reboot command';
                    });
            });

            refresh();
            setInterval(refresh, 2000);
        })();
    </script>
    </div>
</body>

</html>