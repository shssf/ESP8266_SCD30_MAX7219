<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SCD30 - CO2 / Temperature / Humidity</title>
    <link rel="stylesheet" href="/style.css" />
</head>

<body>
    <h1>SCD30 - live</h1>

    <div>
        <form action="/" method="get"><button class="btn" type="submit">Back</button></form>
    </div>

    <div class="card">
        <p><a class="mono" href="/api/scd30">/api/scd30</a></p>
    </div>

    <div class="columns">
        <div class="card">
            <div class="hint">CO₂ (ppm)</div>
            <div id="co2" class="mono">--</div>
        </div>
        <div class="card">
            <div class="hint">Temperature (°C)</div>
            <div id="t" class="mono">--</div>
        </div>
        <div class="card">
            <div class="hint">Humidity (%)</div>
            <div id="rh" class="mono">--</div>
        </div>
    </div>

    <div class="card">
        <h2>Charts</h2>
        <div class="columns">
            <div class="card">
                <div class="hint">CO₂ (ppm)</div>
                <canvas id="chart_co2" width="600" height="200"></canvas>
            </div>
            <div class="card">
                <div class="hint">Temperature (°C)</div>
                <canvas id="chart_t" width="600" height="200"></canvas>
            </div>
            <div class="card">
                <div class="hint">Humidity (%)</div>
                <canvas id="chart_rh" width="600" height="200"></canvas>
            </div>
        </div>
        <p class="hint">Last 300 samples shown; responsive width.</p>
    </div>

    <script>
        (function () {
            var elCo2 = document.getElementById('co2');
            var elT = document.getElementById('t');
            var elRH = document.getElementById('rh');
            var cCO2 = document.getElementById('chart_co2');
            var cT = document.getElementById('chart_t');
            var cRH = document.getElementById('chart_rh');
            var ctxCO2 = cCO2.getContext('2d');
            var ctxT = cT.getContext('2d');
            var ctxRH = cRH.getContext('2d');
            var MAX_POINTS = 300;
            var dataCO2 = [];
            var dataT = [];
            var dataRH = [];
            var sampleTick = 0;

            function pushValue(arr, value) {
                arr.push(value);
                if (arr.length > MAX_POINTS) arr.shift();
            }

            function draw(ctx, data, color, label) {
                var W = ctx.canvas.width, H = ctx.canvas.height;
                var L = 48, R = 14, T = 18, B = 28;
                ctx.clearRect(0, 0, W, H);

                var mn = 1e9, mx = -1e9;
                for (var i = 0; i < data.length; ++i) {
                    var v = data[i];
                    if (v < mn) mn = v;
                    if (v > mx) mx = v;
                }
                if (mn === 1e9) { mn = 0; mx = 1; }
                var span = mx - mn;
                if (span < 0.1) span = 0.1;
                mn -= span * 0.1;
                mx += span * 0.1;

                ctx.strokeStyle = '#232634';
                ctx.lineWidth = 1;
                ctx.beginPath();
                for (var gx = 0; gx <= 6; ++gx) {
                    var x = L + gx * (W - L - R) / 6;
                    ctx.moveTo(x, T);
                    ctx.lineTo(x, H - B);
                }
                for (var gy = 0; gy <= 4; ++gy) {
                    var y = T + gy * (H - T - B) / 4;
                    ctx.moveTo(L, y);
                    ctx.lineTo(W - R, y);
                }
                ctx.stroke();

                ctx.strokeStyle = '#b9beca';
                ctx.beginPath();
                ctx.moveTo(L, T);
                ctx.lineTo(L, H - B);
                ctx.lineTo(W - R, H - B);
                ctx.stroke();

                ctx.fillStyle = '#9aa0ac';
                ctx.font = '12px system-ui';
                ctx.textAlign = 'right';
                for (var ty = 0; ty <= 4; ++ty) {
                    var yv = T + ty * (H - T - B) / 4;
                    var val = mx - (ty * (mx - mn) / 4);
                    var digs = (Math.abs(val) < 10) ? 2 : 0;
                    ctx.fillText(val.toFixed(digs), L - 6, yv + 4);
                }

                ctx.textAlign = 'left';
                ctx.fillStyle = '#cfd3da';
                ctx.fillText(label, L + 8, T + 12);

                if (data.length === 0) return;

                var grad = ctx.createLinearGradient(0, T, 0, H - B);
                grad.addColorStop(0, color);
                grad.addColorStop(1, 'rgba(158,193,255,0.00)');

                ctx.beginPath();
                for (var i = 0; i < data.length; ++i) {
                    var px = L + i * (W - L - R) / Math.max(1, data.length - 1);
                    var py = T + ((mx - data[i]) * (H - T - B) / (mx - mn));
                    if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
                }
                ctx.lineTo(L + (W - L - R), H - B);
                ctx.lineTo(L, H - B);
                ctx.closePath();
                ctx.globalAlpha = 0.16;
                ctx.fillStyle = grad;
                ctx.fill();
                ctx.globalAlpha = 1.0;

                ctx.shadowBlur = 10;
                ctx.shadowColor = 'rgba(62,130,246,0.55)';
                ctx.strokeStyle = color;
                ctx.lineWidth = 2.5;
                ctx.beginPath();
                for (var j = 0; j < data.length; ++j) {
                    var lx = L + j * (W - L - R) / Math.max(1, data.length - 1);
                    var ly = T + ((mx - data[j]) * (H - T - B) / (mx - mn));
                    if (j === 0) ctx.moveTo(lx, ly); else ctx.lineTo(lx, ly);
                }
                ctx.stroke();
                ctx.shadowBlur = 0;
            }

            function resize() {
                function chartWidth(canvas) {
                    var parent = canvas.parentElement;
                    var w = (parent ? parent.clientWidth : canvas.clientWidth) - 16;
                    if (w < 320) w = 320;
                    if (w > 1200) w = 1200;
                    return w;
                }

                cCO2.width = chartWidth(cCO2);
                cCO2.height = 200;
                cT.width = chartWidth(cT);
                cT.height = 200;
                cRH.width = chartWidth(cRH);
                cRH.height = 200;

                draw(ctxCO2, dataCO2, '#22d3ee', 'CO₂ (ppm)');
                draw(ctxT, dataT, '#a78bfa', 'Temperature (°C)');
                draw(ctxRH, dataRH, '#34d399', 'Humidity (%)');
            }

            window.addEventListener('resize', resize);

            async function refresh() {
                try {
                    var r = await fetch('/api/scd30', { cache: 'no-store' });
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    var j = await r.json();

                    var c = (j.co2_ppm !== null ? +j.co2_ppm : null);
                    var tc = (j.temperature_c !== null ? +j.temperature_c : null);
                    var rh = (j.humidity_pct !== null ? +j.humidity_pct : null);

                    elCo2.textContent = (c !== null && isFinite(c)) ? c.toFixed(0) : '--';
                    elT.textContent = (tc !== null && isFinite(tc)) ? tc.toFixed(2) : '--';
                    elRH.textContent = (rh !== null && isFinite(rh)) ? rh.toFixed(1) : '--';

                    if (c !== null && isFinite(c)) pushValue(dataCO2, c);
                    if (tc !== null && isFinite(tc)) pushValue(dataT, tc);
                    if (rh !== null && isFinite(rh)) pushValue(dataRH, rh);

                    sampleTick += 1;
                    if ((sampleTick % 2) === 0) {
                        resize();
                    }
                } catch (e) {
                    elCo2.textContent = 'ERR';
                    elT.textContent = 'ERR';
                    elRH.textContent = 'ERR';
                }
            }

            refresh();
            resize();
            setInterval(refresh, 1000);
        })();
    </script>
</body>

</html>